{"version":3,"sources":["../../../src/internal-plugins/webpack-theme-component-shadowing/index.js"],"names":["path","require","debug","fs","_","pathWithoutExtension","fullPath","parsed","parse","join","dir","name","module","exports","GatsbyThemeComponentShadowingResolverPlugin","constructor","projectRoot","themes","map","themeName","apply","resolver","hooks","relative","tapAsync","request","stack","callback","matchingThemes","getMatchingThemesForPath","length","Error","theme","component","split","themeDir","context","issuer","requestPathIsIssuerShadowPath","requestPath","issuerPath","userSiteDir","resolve","doResolve","describedRelative","builtComponentPath","resolveComponentPath","matchingTheme","ogThemes","filter","cache","concat","Array","from","reverse","find","possibleComponentPath","readdirSync","dirname","e","exists","filepath","ext","extname","filenameWithoutExtension","basename","includes","allMatchingThemes","uniqBy","getBaseShadowDirsForThemes","shadowFiles"],"mappings":"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","sourcesContent":["const path = require(`path`)\nconst debug = require(`debug`)(`gatsby:component-shadowing`)\nconst fs = require(`fs`)\nconst _ = require(`lodash`)\n\nconst pathWithoutExtension = fullPath => {\n  const parsed = path.parse(fullPath)\n  return path.join(parsed.dir, parsed.name)\n}\n\nmodule.exports = class GatsbyThemeComponentShadowingResolverPlugin {\n  cache = {}\n\n  constructor({ projectRoot, themes }) {\n    debug(`themes list`, themes.map(({ themeName }) => themeName))\n    this.themes = themes\n    this.projectRoot = projectRoot\n  }\n\n  apply(resolver) {\n    resolver.hooks.relative.tapAsync(\n      `GatsbyThemeComponentShadowingResolverPlugin`,\n      (request, stack, callback) => {\n        const matchingThemes = this.getMatchingThemesForPath(request.path)\n\n        // 0 matching themes happens a lot for paths we don't want to handle\n        // > 1 matching theme means we have a path like\n        //   `gatsby-theme-blog/src/components/gatsby-theme-something/src/components`\n        if (matchingThemes.length > 1) {\n          throw new Error(\n            `Gatsby can't differentiate between themes ${matchingThemes\n              .map(theme => theme.themeName)\n              .join(` and `)} for path ${request.path}`\n          )\n        }\n\n        if (matchingThemes.length !== 1) {\n          return callback()\n        }\n\n        // theme is the theme package from which we're requiring the relative component\n        const [theme] = matchingThemes\n        // get the location of the component relative to src/\n        const [, component] = request.path.split(\n          path.join(theme.themeDir, `src`)\n        )\n\n        if (\n          /**\n           * if someone adds\n           * ```\n           * modules: [path.resolve(__dirname, 'src'), 'node_modules'],\n           * ```\n           * to the webpack config, `issuer` is `null`, so we skip this check.\n           * note that it's probably a bad idea in general to set `modules`\n           * like this in a theme, but we also shouldn't artificially break\n           * people that do.\n           */\n          request.context.issuer &&\n          /**\n           * An issuer is the file making the require request. It can\n           * be in a user's site or a theme. If the issuer is requesting\n           * a path in the shadow chain that it participates in, then we\n           * will let the request through as normal. Otherwise, we\n           * engage the shadowing algorithm.\n           */\n          this.requestPathIsIssuerShadowPath({\n            requestPath: request.path,\n            issuerPath: request.context.issuer,\n            userSiteDir: path.resolve(`.`),\n          })\n        ) {\n          return resolver.doResolve(\n            resolver.hooks.describedRelative,\n            request,\n            null,\n            {},\n            callback\n          )\n        }\n\n        // This is the shadowing algorithm.\n        const builtComponentPath = this.resolveComponentPath({\n          matchingTheme: theme.themeName,\n          themes: this.themes,\n          component,\n        })\n\n        return resolver.doResolve(\n          resolver.hooks.describedRelative,\n          { ...request, path: builtComponentPath || request.path },\n          null,\n          {},\n          callback\n        )\n      }\n    )\n  }\n\n  // check the cache, the user's project, and finally the theme files\n  resolveComponentPath({ matchingTheme: theme, themes: ogThemes, component }) {\n    // don't include matching theme in possible shadowing paths\n    const themes = ogThemes.filter(({ themeName }) => themeName !== theme)\n    if (!this.cache[`${theme}-${component}`]) {\n      this.cache[`${theme}-${component}`] = [\n        path.join(path.resolve(`.`), `src`, theme),\n      ]\n        .concat(\n          Array.from(themes)\n            .reverse()\n            .map(({ themeDir }) => path.join(themeDir, `src`, theme))\n        )\n        .map(dir => path.join(dir, component))\n        .find(possibleComponentPath => {\n          debug(`possibleComponentPath`, possibleComponentPath)\n          let dir\n          try {\n            // we use fs/path instead of require.resolve to work with\n            // TypeScript and alternate syntaxes\n            dir = fs.readdirSync(path.dirname(possibleComponentPath))\n          } catch (e) {\n            return false\n          }\n          const exists = dir\n            .map(filepath => {\n              const ext = path.extname(filepath)\n              const filenameWithoutExtension = path.basename(filepath, ext)\n              return filenameWithoutExtension\n            })\n            .includes(\n              path.basename(\n                possibleComponentPath,\n                path.extname(possibleComponentPath)\n              )\n            )\n          return exists\n        })\n    }\n\n    return this.cache[`${theme}-${component}`]\n  }\n\n  getMatchingThemesForPath(filepath) {\n    // find out which theme's src/components dir we're requiring from\n    const allMatchingThemes = this.themes.filter(({ themeDir }) =>\n      filepath.includes(path.join(themeDir, `src`))\n    )\n\n    // The same theme can be included twice in the themes list causing multiple\n    // matches. This case should only be counted as a single match for that theme.\n    return _.uniqBy(allMatchingThemes, `themeName`)\n  }\n\n  // given a theme name, return all of the possible shadow locations\n  getBaseShadowDirsForThemes(theme) {\n    return Array.from(this.themes)\n      .reverse()\n      .map(({ themeName, themeDir }) => {\n        if (themeName === theme) {\n          return path.join(themeDir, `src`)\n        } else {\n          return path.join(themeDir, `src`, theme)\n        }\n      })\n  }\n\n  requestPathIsIssuerShadowPath({ requestPath, issuerPath, userSiteDir }) {\n    // get the issuer's theme\n    const matchingThemes = this.getMatchingThemesForPath(requestPath)\n    if (matchingThemes.length !== 1) {\n      return false\n    }\n    const [theme] = matchingThemes\n\n    // get the location of the component relative to src/\n    const [, component] = requestPath.split(path.join(theme.themeDir, `src`))\n\n    // get list of potential shadow locations\n    const shadowFiles = this.getBaseShadowDirsForThemes(theme.themeName)\n      .concat(path.join(userSiteDir, `src`, theme.themeName))\n      .map(dir => path.join(dir, component))\n\n    // if the issuer is requesting a path that is a potential shadow path of itself\n    return shadowFiles.includes(pathWithoutExtension(issuerPath))\n  }\n}\n"],"file":"index.js"}