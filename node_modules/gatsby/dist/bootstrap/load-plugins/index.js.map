{"version":3,"sources":["../../../src/bootstrap/load-plugins/index.js"],"names":["_","require","store","nodeAPIs","browserAPIs","ssrAPIs","loadPlugins","collatePluginAPIs","handleBadExports","handleMultipleReplaceRenderers","getAPI","api","keys","reduce","merged","key","flattenPlugins","plugins","flattened","extractPlugins","plugin","pluginOptions","forEach","subPlugin","push","module","exports","config","rootDir","latestAPIs","apis","currentAPIs","browser","node","ssr","flattenedPlugins","x","badExports","dispatch","type","payload"],"mappings":";;AAAA,MAAMA,CAAC,GAAGC,OAAO,CAAE,QAAF,CAAjB;;AAEA,MAAM;AAAEC,EAAAA;AAAF,IAAYD,OAAO,CAAE,aAAF,CAAzB;;AACA,MAAME,QAAQ,GAAGF,OAAO,CAAE,2BAAF,CAAxB;;AACA,MAAMG,WAAW,GAAGH,OAAO,CAAE,8BAAF,CAA3B;;AACA,MAAMI,OAAO,GAAGJ,OAAO,CAAE,iCAAF,CAAvB;;AACA,MAAMK,WAAW,GAAGL,OAAO,CAAE,QAAF,CAA3B;;AACA,MAAM;AACJM,EAAAA,iBADI;AAEJC,EAAAA,gBAFI;AAGJC,EAAAA;AAHI,IAIFR,OAAO,CAAE,YAAF,CAJX;;AAMA,MAAMS,MAAM,GAAGC,GAAG,IAChBX,CAAC,CAACY,IAAF,CAAOD,GAAP,EAAYE,MAAZ,CAAmB,CAACC,MAAD,EAASC,GAAT,KAAiB;AAClCD,EAAAA,MAAM,CAACC,GAAD,CAAN,GAAcf,CAAC,CAACY,IAAF,CAAOD,GAAG,CAACI,GAAD,CAAV,CAAd;AACA,SAAOD,MAAP;AACD,CAHD,EAGG,EAHH,CADF,C,CAMA;AACA;AACA;;;AACA,MAAME,cAAc,GAAGC,OAAO,IAAI;AAChC,QAAMC,SAAS,GAAG,EAAlB;;AACA,QAAMC,cAAc,GAAGC,MAAM,IAAI;AAC/BA,IAAAA,MAAM,CAACC,aAAP,CAAqBJ,OAArB,CAA6BK,OAA7B,CAAqCC,SAAS,IAAI;AAChDL,MAAAA,SAAS,CAACM,IAAV,CAAeD,SAAf;AACAJ,MAAAA,cAAc,CAACI,SAAD,CAAd;AACD,KAHD;AAID,GALD;;AAOAN,EAAAA,OAAO,CAACK,OAAR,CAAgBF,MAAM,IAAI;AACxBF,IAAAA,SAAS,CAACM,IAAV,CAAeJ,MAAf;AACAD,IAAAA,cAAc,CAACC,MAAD,CAAd;AACD,GAHD;AAKA,SAAOF,SAAP;AACD,CAfD;;AAiBAO,MAAM,CAACC,OAAP,GAAiB,OAAOC,MAAM,GAAG,EAAhB,EAAoBC,OAAO,GAAG,IAA9B,EAAoCC,UAAU,GAAG,EAAjD,KAAwD;AACvE,QAAMC,IAAI,GAAG;AACXC,IAAAA,WAAW,EAAErB,MAAM,CAAC;AAClBsB,MAAAA,OAAO,EAAE5B,WADS;AAElB6B,MAAAA,IAAI,EAAE9B,QAFY;AAGlB+B,MAAAA,GAAG,EAAE7B;AAHa,KAAD,CADR;AAMXwB,IAAAA,UANW,CAQb;;AARa,GAAb;AASA,QAAMZ,OAAO,GAAGX,WAAW,CAACqB,MAAD,EAASC,OAAT,CAA3B,CAVuE,CAYvE;;AACA,MAAIO,gBAAgB,GAAGnB,cAAc,CAACC,OAAD,CAArC,CAbuE,CAevE;AACA;;AACA,QAAMmB,CAAC,GAAG7B,iBAAiB,mBAAMuB,IAAN;AAAYK,IAAAA;AAAZ,KAA3B;AACAA,EAAAA,gBAAgB,GAAGC,CAAC,CAACD,gBAArB;AACA,QAAME,UAAU,GAAGD,CAAC,CAACC,UAArB,CAnBuE,CAqBvE;;AACA7B,EAAAA,gBAAgB,mBAAMsB,IAAN;AAAYO,IAAAA;AAAZ,KAAhB,CAtBuE,CAwBvE;;AACAF,EAAAA,gBAAgB,GAAG1B,8BAA8B,CAAC;AAChD0B,IAAAA;AADgD,GAAD,CAAjD,CAzBuE,CA6BvE;;AACAjC,EAAAA,KAAK,CAACoC,QAAN,CAAe;AACbC,IAAAA,IAAI,EAAG,4BADM;AAEbC,IAAAA,OAAO,EAAEL;AAFI,GAAf;AAKA,SAAOA,gBAAP;AACD,CApCD","sourcesContent":["const _ = require(`lodash`)\n\nconst { store } = require(`../../redux`)\nconst nodeAPIs = require(`../../utils/api-node-docs`)\nconst browserAPIs = require(`../../utils/api-browser-docs`)\nconst ssrAPIs = require(`../../../cache-dir/api-ssr-docs`)\nconst loadPlugins = require(`./load`)\nconst {\n  collatePluginAPIs,\n  handleBadExports,\n  handleMultipleReplaceRenderers,\n} = require(`./validate`)\n\nconst getAPI = api =>\n  _.keys(api).reduce((merged, key) => {\n    merged[key] = _.keys(api[key])\n    return merged\n  }, {})\n\n// Create a \"flattened\" array of plugins with all subplugins\n// brought to the top-level. This simplifies running gatsby-* files\n// for subplugins.\nconst flattenPlugins = plugins => {\n  const flattened = []\n  const extractPlugins = plugin => {\n    plugin.pluginOptions.plugins.forEach(subPlugin => {\n      flattened.push(subPlugin)\n      extractPlugins(subPlugin)\n    })\n  }\n\n  plugins.forEach(plugin => {\n    flattened.push(plugin)\n    extractPlugins(plugin)\n  })\n\n  return flattened\n}\n\nmodule.exports = async (config = {}, rootDir = null, latestAPIs = {}) => {\n  const apis = {\n    currentAPIs: getAPI({\n      browser: browserAPIs,\n      node: nodeAPIs,\n      ssr: ssrAPIs,\n    }),\n    latestAPIs,\n  }\n  // Collate internal plugins, site config plugins, site default plugins\n  const plugins = loadPlugins(config, rootDir)\n\n  // Create a flattened array of the plugins\n  let flattenedPlugins = flattenPlugins(plugins)\n\n  // Work out which plugins use which APIs, including those which are not\n  // valid Gatsby APIs, aka 'badExports'\n  const x = collatePluginAPIs({ ...apis, flattenedPlugins })\n  flattenedPlugins = x.flattenedPlugins\n  const badExports = x.badExports\n\n  // Show errors for any non-Gatsby APIs exported from plugins\n  handleBadExports({ ...apis, badExports })\n\n  // Show errors when ReplaceRenderer has been implemented multiple times\n  flattenedPlugins = handleMultipleReplaceRenderers({\n    flattenedPlugins,\n  })\n\n  // If we get this far, everything looks good. Update the store\n  store.dispatch({\n    type: `SET_SITE_FLATTENED_PLUGINS`,\n    payload: flattenedPlugins,\n  })\n\n  return flattenedPlugins\n}\n"],"file":"index.js"}