{"version":3,"sources":["../../../src/redux/reducers/components.js"],"names":["normalize","require","interpret","componentMachine","services","Map","programStatus","module","exports","state","action","type","payload","forEach","s","send","componentPath","component","service","has","machine","withContext","query","get","pages","Set","path","isInBootstrap","start","set","context","contextModified","Object","assign","value","servicesToSendEventTo","filter","Boolean","isPage","delete","page"],"mappings":"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","sourcesContent":["const normalize = require(`normalize-path`)\nconst { interpret } = require(`xstate`)\n\nconst componentMachine = require(`../machines/page-component`)\n\nconst services = new Map()\nlet programStatus = `BOOTSTRAPPING`\n\nmodule.exports = (state = new Map(), action) => {\n  switch (action.type) {\n    case `DELETE_CACHE`:\n      return new Map()\n    case `SET_PROGRAM_STATUS`:\n      programStatus = action.payload\n      if (programStatus === `BOOTSTRAP_QUERY_RUNNING_FINISHED`) {\n        services.forEach(s => s.send(`BOOTSTRAP_FINISHED`))\n      }\n      return state\n    case `CREATE_PAGE`: {\n      action.payload.componentPath = normalize(action.payload.component)\n      // Create XState service.\n      let service\n      if (!services.has(action.payload.componentPath)) {\n        const machine = componentMachine.withContext({\n          componentPath: action.payload.componentPath,\n          query: state.get(action.payload.componentPath)?.query || ``,\n          pages: new Set([action.payload.path]),\n          isInBootstrap: programStatus === `BOOTSTRAPPING`,\n        })\n        service = interpret(machine).start()\n        // .onTransition(nextState => {\n        // console.log(\n        // `component machine value`,\n        // _.pick(nextState, [`value`, `context`, `event`])\n        // )\n        // })\n        // .start()\n        services.set(action.payload.componentPath, service)\n      } else {\n        service = services.get(action.payload.componentPath)\n        if (!service.state.context.pages.has(action.payload.path)) {\n          service.send({ type: `NEW_PAGE_CREATED`, path: action.payload.path })\n        } else if (action.contextModified) {\n          service.send({\n            type: `PAGE_CONTEXT_MODIFIED`,\n            path: action.payload.path,\n          })\n        }\n      }\n\n      state.set(\n        action.payload.componentPath,\n        Object.assign(\n          {\n            query: ``,\n          },\n          service.state.context\n        )\n      )\n      return state\n    }\n    case `QUERY_EXTRACTED`: {\n      action.payload.componentPath = normalize(action.payload.componentPath)\n      const service = services.get(action.payload.componentPath)\n\n      if (service.state.value === `queryExtractionBabelError`) {\n        // Do nothing until the babel error is fixed.\n        return state\n      }\n\n      // Check if the query has changed or not.\n      if (service.state.context.query === action.payload.query) {\n        service.send(`QUERY_DID_NOT_CHANGE`)\n      } else {\n        service.send({\n          type: `QUERY_CHANGED`,\n          query: action.payload.query,\n        })\n      }\n\n      state.set(action.payload.componentPath, {\n        ...service.state.context,\n      })\n      return state\n    }\n    case `QUERY_EXTRACTION_BABEL_SUCCESS`:\n    case `QUERY_EXTRACTION_BABEL_ERROR`:\n    case `QUERY_EXTRACTION_GRAPHQL_ERROR`: {\n      let servicesToSendEventTo\n      if (\n        typeof action.payload.componentPath !== `string` &&\n        action.type === `QUERY_EXTRACTION_GRAPHQL_ERROR`\n      ) {\n        // if this is globabl query extraction error, send it to all page component services\n        servicesToSendEventTo = services\n      } else {\n        action.payload.componentPath = normalize(action.payload.componentPath)\n        servicesToSendEventTo = [\n          services.get(action.payload.componentPath),\n        ].filter(Boolean)\n      }\n\n      servicesToSendEventTo.forEach(service =>\n        service.send({\n          type: action.type,\n          ...action.payload,\n        })\n      )\n\n      return state\n    }\n    case `PAGE_QUERY_RUN`: {\n      if (action.payload.isPage) {\n        action.payload.componentPath = normalize(action.payload.componentPath)\n        const service = services.get(action.payload.componentPath)\n        // TODO we want to keep track of whether there's any outstanding queries still\n        // running as this will mark queries as complete immediately even though\n        // a page component could have thousands of pages will processing.\n        // This can be done once we start modeling Pages as well.\n        service.send({\n          type: `QUERIES_COMPLETE`,\n        })\n      }\n      return state\n    }\n    case `REMOVE_TEMPLATE_COMPONENT`: {\n      action.payload.componentPath = normalize(action.payload.componentPath)\n      state.delete(action.payload.componentPath)\n      return state\n    }\n    case `DELETE_PAGE`: {\n      const service = services.get(normalize(action.payload.component))\n      service.send({\n        type: `DELETE_PAGE`,\n        page: action.payload,\n      })\n      return state\n    }\n  }\n\n  return state\n}\n"],"file":"components.js"}