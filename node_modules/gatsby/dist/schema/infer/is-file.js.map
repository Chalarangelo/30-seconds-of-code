{"version":3,"sources":["../../../src/schema/infer/is-file.js"],"names":["path","require","slash","mime","isRelative","isRelativeUrl","getValueAt","isFile","nodeStore","field","relativePath","filePath","getFilePath","filePathExists","getNodesByType","some","node","absolutePath","module","exports","getFirstValueAt","selector","value","Array","isArray","typeName","split","looksLikeFile","isAbsolute","getType","normalizedPath","find","getAbsolutePath","dir","getBaseDir","withDir","withBaseDir","map","findAncestorNode","internal","type","p","posix","join","childNode","predicate","parent","getNode"],"mappings":";;AAAA,MAAMA,IAAI,GAAGC,OAAO,CAAE,MAAF,CAApB;;AACA,MAAMC,KAAK,GAAGD,OAAO,CAAE,OAAF,CAArB;;AACA,MAAME,IAAI,GAAGF,OAAO,CAAE,MAAF,CAApB;;AACA,MAAMG,UAAU,GAAGH,OAAO,CAAE,aAAF,CAA1B;;AACA,MAAMI,aAAa,GAAGJ,OAAO,CAAE,iBAAF,CAA7B;;AACA,MAAM;AAAEK,EAAAA;AAAF,IAAiBL,OAAO,CAAE,0BAAF,CAA9B;;AAEA,MAAMM,MAAM,GAAG,CAACC,SAAD,EAAYC,KAAZ,EAAmBC,YAAnB,KAAoC;AACjD,QAAMC,QAAQ,GAAGC,WAAW,CAACJ,SAAD,EAAYC,KAAZ,EAAmBC,YAAnB,CAA5B;AACA,MAAI,CAACC,QAAL,EAAe,OAAO,KAAP;AACf,QAAME,cAAc,GAAGL,SAAS,CAC7BM,cADoB,CACJ,MADI,EAEpBC,IAFoB,CAEfC,IAAI,IAAIA,IAAI,CAACC,YAAL,KAAsBN,QAFf,CAAvB;AAGA,SAAOE,cAAP;AACD,CAPD;;AASAK,MAAM,CAACC,OAAP,GAAiB;AACfZ,EAAAA;AADe,CAAjB;;AAIA,MAAMa,eAAe,GAAG,CAACJ,IAAD,EAAOK,QAAP,KAAoB;AAC1C,MAAIC,KAAK,GAAGhB,UAAU,CAACU,IAAD,EAAOK,QAAP,CAAtB;;AACA,SAAOE,KAAK,CAACC,OAAN,CAAcF,KAAd,CAAP,EAA6B;AAC3BA,IAAAA,KAAK,GAAGA,KAAK,CAAC,CAAD,CAAb;AACD;;AACD,SAAOA,KAAP;AACD,CAND;;AAQA,MAAMV,WAAW,GAAG,CAACJ,SAAD,EAAYC,KAAZ,EAAmBC,YAAnB,KAAoC;AACtD,QAAM,CAACe,QAAD,EAAW,GAAGJ,QAAd,IAA0BZ,KAAK,CAACiB,KAAN,CAAa,GAAb,CAAhC;AAEA,MAAID,QAAQ,KAAM,MAAlB,EAAyB,OAAO,IAAP;AAEzB,QAAME,aAAa,GACjB,CAAC3B,IAAI,CAAC4B,UAAL,CAAgBlB,YAAhB,CAAD,IACAP,IAAI,CAAC0B,OAAL,CAAanB,YAAb,MAA+B,IAD/B,IAEA;AACAP,EAAAA,IAAI,CAAC0B,OAAL,CAAanB,YAAb,MAAgC,0BAHhC,IAIAN,UAAU,CAACM,YAAD,CAJV,IAKAL,aAAa,CAACK,YAAD,CANf;AAQA,MAAI,CAACiB,aAAL,EAAoB,OAAO,IAAP;AAEpB,QAAMG,cAAc,GAAG5B,KAAK,CAACQ,YAAD,CAA5B;AACA,QAAMM,IAAI,GAAGR,SAAS,CACnBM,cADU,CACKW,QADL,EAEVM,IAFU,CAELf,IAAI,IAAII,eAAe,CAACJ,IAAD,EAAOK,QAAP,CAAf,KAAoCS,cAFvC,CAAb;AAIA,SAAOd,IAAI,GAAGgB,eAAe,CAACxB,SAAD,EAAYQ,IAAZ,EAAkBc,cAAlB,CAAlB,GAAsD,IAAjE;AACD,CArBD;;AAuBA,MAAME,eAAe,GAAG,CAACxB,SAAD,EAAYQ,IAAZ,EAAkBN,YAAlB,KAAmC;AACzD,QAAMuB,GAAG,GAAGC,UAAU,CAAC1B,SAAD,EAAYQ,IAAZ,CAAtB;AACA,QAAMmB,OAAO,GAAGC,WAAW,CAACH,GAAD,CAA3B;AACA,SAAOA,GAAG,GACNV,KAAK,CAACC,OAAN,CAAcd,YAAd,IACEA,YAAY,CAAC2B,GAAb,CAAiBF,OAAjB,CADF,GAEEA,OAAO,CAACzB,YAAD,CAHH,GAIN,IAJJ;AAKD,CARD;;AAUA,MAAMwB,UAAU,GAAG,CAAC1B,SAAD,EAAYQ,IAAZ,KAAqB;AACtC,MAAIA,IAAJ,EAAU;AACR,UAAM;AAAEiB,MAAAA;AAAF,QACJK,gBAAgB,CACd9B,SADc,EAEdQ,IAFc,EAGdA,IAAI,IAAIA,IAAI,CAACuB,QAAL,CAAcC,IAAd,KAAwB,MAHlB,CAAhB,IAIK,EALP;AAMA,WAAOP,GAAP;AACD;;AACD,SAAO,IAAP;AACD,CAXD;;AAaA,MAAMG,WAAW,GAAGH,GAAG,IAAIQ,CAAC,IAAIzC,IAAI,CAAC0C,KAAL,CAAWC,IAAX,CAAgBV,GAAhB,EAAqB/B,KAAK,CAACuC,CAAD,CAA1B,CAAhC;;AAEA,MAAMH,gBAAgB,GAAG,CAAC9B,SAAD,EAAYoC,SAAZ,EAAuBC,SAAvB,KAAqC;AAC5D,MAAI7B,IAAI,GAAG4B,SAAX;;AACA,KAAG;AACD,QAAIC,SAAS,CAAC7B,IAAD,CAAb,EAAqB;AACnB,aAAOA,IAAP;AACD;AACF,GAJD,QAIUA,IAAI,GAAGA,IAAI,CAAC8B,MAAL,IAAetC,SAAS,CAACuC,OAAV,CAAkB/B,IAAI,CAAC8B,MAAvB,CAJhC;;AAKA,SAAO,IAAP;AACD,CARD","sourcesContent":["const path = require(`path`)\nconst slash = require(`slash`)\nconst mime = require(`mime`)\nconst isRelative = require(`is-relative`)\nconst isRelativeUrl = require(`is-relative-url`)\nconst { getValueAt } = require(`../../utils/get-value-at`)\n\nconst isFile = (nodeStore, field, relativePath) => {\n  const filePath = getFilePath(nodeStore, field, relativePath)\n  if (!filePath) return false\n  const filePathExists = nodeStore\n    .getNodesByType(`File`)\n    .some(node => node.absolutePath === filePath)\n  return filePathExists\n}\n\nmodule.exports = {\n  isFile,\n}\n\nconst getFirstValueAt = (node, selector) => {\n  let value = getValueAt(node, selector)\n  while (Array.isArray(value)) {\n    value = value[0]\n  }\n  return value\n}\n\nconst getFilePath = (nodeStore, field, relativePath) => {\n  const [typeName, ...selector] = field.split(`.`)\n\n  if (typeName === `File`) return null\n\n  const looksLikeFile =\n    !path.isAbsolute(relativePath) &&\n    mime.getType(relativePath) !== null &&\n    // FIXME: Do we need all of this?\n    mime.getType(relativePath) !== `application/x-msdownload` &&\n    isRelative(relativePath) &&\n    isRelativeUrl(relativePath)\n\n  if (!looksLikeFile) return null\n\n  const normalizedPath = slash(relativePath)\n  const node = nodeStore\n    .getNodesByType(typeName)\n    .find(node => getFirstValueAt(node, selector) === normalizedPath)\n\n  return node ? getAbsolutePath(nodeStore, node, normalizedPath) : null\n}\n\nconst getAbsolutePath = (nodeStore, node, relativePath) => {\n  const dir = getBaseDir(nodeStore, node)\n  const withDir = withBaseDir(dir)\n  return dir\n    ? Array.isArray(relativePath)\n      ? relativePath.map(withDir)\n      : withDir(relativePath)\n    : null\n}\n\nconst getBaseDir = (nodeStore, node) => {\n  if (node) {\n    const { dir } =\n      findAncestorNode(\n        nodeStore,\n        node,\n        node => node.internal.type === `File`\n      ) || {}\n    return dir\n  }\n  return null\n}\n\nconst withBaseDir = dir => p => path.posix.join(dir, slash(p))\n\nconst findAncestorNode = (nodeStore, childNode, predicate) => {\n  let node = childNode\n  do {\n    if (predicate(node)) {\n      return node\n    }\n  } while ((node = node.parent && nodeStore.getNode(node.parent)))\n  return null\n}\n"],"file":"is-file.js"}